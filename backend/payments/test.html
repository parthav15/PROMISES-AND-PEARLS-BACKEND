<!DOCTYPE html>
<html>
<head>
    <title>Print Payment Flow</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        .status { margin: 15px 0; padding: 10px; border-radius: 4px; display: none; }
        .loading { background: #d9edf7; color: #31708f; }
        .success { background: #dff0d8; color: #3c763d; }
        .error { background: #f2dede; color: #a94442; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Print Payment Test</h1>
        
        <div class="input-group">
            <label for="printJobId">Print Job ID:</label>
            <input type="text" id="printJobId" placeholder="Enter print job ID">
            <button onclick="startPaymentFlow()">Start Payment</button>
        </div>

        <div id="loadingStatus" class="status loading">Processing...</div>
        <div id="successStatus" class="status success"></div>
        <div id="errorStatus" class="status error"></div>

        <pre id="responseOutput"></pre>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000/';  // Update with your actual base URL

        async function startPaymentFlow() {
            const printJobId = document.getElementById('printJobId').value;
            const loading = document.getElementById('loadingStatus');
            const success = document.getElementById('successStatus');
            const error = document.getElementById('errorStatus');
            const output = document.getElementById('responseOutput');

            // Reset UI
            loading.style.display = 'block';
            success.style.display = 'none';
            error.style.display = 'none';
            output.textContent = '';

            try {
                // Create Order
                const orderResponse = await fetch(`${BASE_URL}payments/create_order/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `booking_id=${printJobId}`
                });

                const orderData = await orderResponse.json();
                output.textContent = JSON.stringify(orderData, null, 2);

                if (!orderData.success) {
                    throw new Error(orderData.message || 'Failed to create order');
                }

                // Initialize Razorpay
                const options = {
                    key: 'rzp_test_ew74Ktx27rLLPC',
                    amount: orderData.amount,
                    currency: orderData.currency,
                    name: "EZ Prints",
                    description: "Payment for print job",
                    image: "https://developers.ntftravel.com/media/images/logo2.jpg",
                    order_id: orderData.order_id,
                    handler: async function(response) {
                        await verifyPayment(response, printJobId);
                    },
                    modal: {
                        ondismiss: () => {
                            loading.style.display = 'none';
                            error.textContent = 'Payment cancelled by user';
                            error.style.display = 'block';
                        }
                    },
                    prefill: {
                        name: "Dhruv",
                        email: "dhruv@example.com",
                    },
                    theme: {
                        color: "#3399cc"
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
                loading.style.display = 'none';

            } catch (err) {
                loading.style.display = 'none';
                error.textContent = err.message;
                error.style.display = 'block';
                console.error('Payment Error:', err);
            }
        }

        async function verifyPayment(paymentResponse, printJobId) {
            const loading = document.getElementById('loadingStatus');
            const success = document.getElementById('successStatus');
            const error = document.getElementById('errorStatus');
            const output = document.getElementById('responseOutput');

            loading.style.display = 'block';
            success.style.display = 'none';
            error.style.display = 'none';

            try {
                const verifyResponse = await fetch(`${BASE_URL}payments/verify_order/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        razorpay_payment_id: paymentResponse.razorpay_payment_id,
                        razorpay_order_id: paymentResponse.razorpay_order_id,
                        razorpay_signature: paymentResponse.razorpay_signature
                    })
                });

                const verificationData = await verifyResponse.json();
                output.textContent += '\n\nVerification Response:\n' + JSON.stringify(verificationData, null, 2);

                if (verificationData.success) {
                    success.textContent = 'Payment verified successfully! Redirecting...';
                    success.style.display = 'block';
                    
                    // Simulate redirect
                    setTimeout(() => {
                        window.location.href = `/details/${printJobId}`;
                    }, 3000);
                } else {
                    throw new Error(verificationData.message || 'Payment verification failed');
                }
            } catch (err) {
                error.textContent = err.message;
                error.style.display = 'block';
                console.error('Verification Error:', err);
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>